#! /bin/sh
set -e
export LC_ALL=C TERM="xterm"
set -x
env > /etc/envvars

run_command () {
   if [ -x $1 ]; then
        echo >&2 "*** Running: $1"
        $1
        retval=$?
        if [ $retval != 0 ];
        then
            echo >&2 "*** Failed with return value: $?"
            exit $retval
        fi
    fi
}

run_startup_files() {
   #running /etc/my_init.d/
   echo "Starting pre-service scritps in /etc/my_init.d"
   for script in /etc/my_init.d/*
    do
     run_command $script
   done

   # running /etc/rc.local 
   run_command /etc/rc.local
}

start_runit () {
   echo "Booting runit daemon..."
   exec /sbin/runsvdir -P /etc/service
}

shutdown_runit_services() {
   echo "Begin shutting down runit services..."
   /sbin/sv down /etc/service/*
}

#condition for --skip-startup-files
if ![ `echo $@ | grep -c "\-\-skip-startup-files" ` -gt 0 ] ; then
   run_startup_files
fi

#condition for --skip-runit
if ![ `echo $@ | grep -c "\-\-skip-runit" ` -gt 0 ] ; then
   start_runit
  else 
  [ "$1" == '--' ] && shift
  exec $@
fi
